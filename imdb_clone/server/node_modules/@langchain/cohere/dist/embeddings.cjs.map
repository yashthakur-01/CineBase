{"version":3,"file":"embeddings.cjs","names":["Embeddings","fields?: Partial<CohereEmbeddingsParams> & {\n      verbose?: boolean;\n    } & CohereClientOptions","getCohereClient","texts: string[]","embeddings: number[][]","text: string","request: EmbedRequest","request: Parameters<typeof this.client.embed>[0]","e: any"],"sources":["../src/embeddings.ts"],"sourcesContent":["import { CohereClient } from \"cohere-ai\";\nimport type { EmbedRequest } from \"cohere-ai/api/client/index.js\";\n\nimport { Embeddings, EmbeddingsParams } from \"@langchain/core/embeddings\";\nimport { chunkArray } from \"@langchain/core/utils/chunk_array\";\nimport { CohereClientOptions, getCohereClient } from \"./client.js\";\n\n/**\n * Interface that extends EmbeddingsParams and defines additional\n * parameters specific to the CohereEmbeddings class.\n */\nexport interface CohereEmbeddingsParams extends EmbeddingsParams {\n  model?: string;\n\n  /**\n   * The maximum number of documents to embed in a single request. This is\n   * limited by the Cohere API to a maximum of 96.\n   */\n  batchSize?: number;\n\n  /**\n   * Specifies the type of embeddings you want to generate.\n   */\n  embeddingTypes?: Array<string>;\n\n  /**\n   * Specifies the type of input you're giving to the model.\n   * Not required for older versions of the embedding models (i.e. anything lower than v3),\n   * but is required for more recent versions (i.e. anything bigger than v2).\n   *\n   * * `search_document` - Use this when you encode documents for embeddings that you store in a vector database for search use-cases.\n   * * `search_query` - Use this when you query your vector DB to find relevant documents.\n   * * `classification` - Use this when you use the embeddings as an input to a text classifier.\n   * * `clustering` - Use this when you want to cluster the embeddings.\n   */\n  inputType?: string;\n}\n\n/**\n * A class for generating embeddings using the Cohere API.\n */\nexport class CohereEmbeddings\n  extends Embeddings\n  implements CohereEmbeddingsParams\n{\n  model: string | undefined;\n\n  batchSize = 48;\n\n  embeddingTypes = [\"float\"];\n\n  private client: CohereClient;\n\n  /**\n   * Constructor for the CohereEmbeddings class.\n   * @param fields - An optional object with properties to configure the instance.\n   */\n  constructor(\n    fields?: Partial<CohereEmbeddingsParams> & {\n      verbose?: boolean;\n    } & CohereClientOptions\n  ) {\n    const fieldsWithDefaults = { maxConcurrency: 2, ...fields };\n\n    super(fieldsWithDefaults);\n\n    this.client = getCohereClient(fieldsWithDefaults);\n    this.model = fieldsWithDefaults?.model ?? this.model;\n\n    if (!this.model) {\n      throw new Error(\n        \"Model not specified for CohereEmbeddings instance. Please provide a model name from the options here: https://docs.cohere.com/reference/embed\"\n      );\n    }\n\n    this.batchSize = fieldsWithDefaults?.batchSize ?? this.batchSize;\n    this.embeddingTypes =\n      fieldsWithDefaults?.embeddingTypes ?? this.embeddingTypes;\n  }\n\n  /**\n   * Generates embeddings for an array of texts.\n   * @param texts - An array of strings to generate embeddings for.\n   * @returns A Promise that resolves to an array of embeddings.\n   */\n  async embedDocuments(texts: string[]): Promise<number[][]> {\n    const batches = chunkArray(texts, this.batchSize);\n\n    const batchRequests = batches.map((batch) =>\n      this.embeddingWithRetry({\n        model: this.model,\n        texts: batch,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        inputType: \"search_document\" as any,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        embeddingTypes: this.embeddingTypes as any,\n      })\n    );\n\n    const batchResponses = await Promise.all(batchRequests);\n\n    const embeddings: number[][] = [];\n\n    for (let i = 0; i < batchResponses.length; i += 1) {\n      const batch = batches[i];\n      const { embeddings: batchResponse } = batchResponses[i];\n      for (let j = 0; j < batch.length; j += 1) {\n        if (\"float\" in batchResponse && batchResponse.float) {\n          embeddings.push(batchResponse.float[j]);\n        } else if (Array.isArray(batchResponse)) {\n          embeddings.push(batchResponse[j as number]);\n        }\n      }\n    }\n\n    return embeddings;\n  }\n\n  /**\n   * Generates an embedding for a single text.\n   * @param text - A string to generate an embedding for.\n   * @returns A Promise that resolves to an array of numbers representing the embedding.\n   */\n  async embedQuery(text: string): Promise<number[]> {\n    const { embeddings } = await this.embeddingWithRetry({\n      model: this.model,\n      texts: [text],\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      inputType: \"search_query\" as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      embeddingTypes: this.embeddingTypes as any,\n    });\n    if (\"float\" in embeddings && embeddings.float) {\n      return embeddings.float[0];\n    } else if (Array.isArray(embeddings)) {\n      return embeddings[0];\n    } else {\n      throw new Error(\n        `Invalid response from Cohere API. Received: ${JSON.stringify(\n          embeddings,\n          null,\n          2\n        )}`\n      );\n    }\n  }\n\n  async embed(request: EmbedRequest): Promise<number[]> {\n    const { embeddings } = await this.embeddingWithRetry(request);\n    if (\"float\" in embeddings && embeddings.float) {\n      return embeddings.float[0];\n    } else if (Array.isArray(embeddings)) {\n      return embeddings[0];\n    } else {\n      throw new Error(\n        `Invalid response from Cohere API. Received: ${JSON.stringify(\n          embeddings,\n          null,\n          2\n        )}`\n      );\n    }\n  }\n\n  /**\n   * Generates embeddings with retry capabilities.\n   * @param request - An object containing the request parameters for generating embeddings.\n   * @returns A Promise that resolves to the API response.\n   */\n  private async embeddingWithRetry(\n    request: Parameters<typeof this.client.embed>[0]\n  ) {\n    return this.caller.call(async () => {\n      let response;\n      try {\n        response = await this.client.embed(request);\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      } catch (e: any) {\n        e.status = e.status ?? e.statusCode;\n        throw e;\n      }\n      return response;\n    });\n  }\n\n  get lc_secrets(): { [key: string]: string } | undefined {\n    return {\n      apiKey: \"COHERE_API_KEY\",\n      api_key: \"COHERE_API_KEY\",\n    };\n  }\n\n  get lc_aliases(): { [key: string]: string } | undefined {\n    return {\n      apiKey: \"cohere_api_key\",\n      api_key: \"cohere_api_key\",\n    };\n  }\n}\n"],"mappings":";;;;;;;;;AAyCA,IAAa,mBAAb,cACUA,uCAEV;CACE;CAEA,YAAY;CAEZ,iBAAiB,CAAC,OAAQ;CAE1B,AAAQ;;;;;CAMR,YACEC,QAGA;EACA,MAAM,qBAAqB;GAAE,gBAAgB;GAAG,GAAG;EAAQ;EAE3D,MAAM,mBAAmB;EAEzB,KAAK,SAASC,+BAAgB,mBAAmB;EACjD,KAAK,QAAQ,oBAAoB,SAAS,KAAK;AAE/C,MAAI,CAAC,KAAK,MACR,OAAM,IAAI,MACR;EAIJ,KAAK,YAAY,oBAAoB,aAAa,KAAK;EACvD,KAAK,iBACH,oBAAoB,kBAAkB,KAAK;CAC9C;;;;;;CAOD,MAAM,eAAeC,OAAsC;EACzD,MAAM,6DAAqB,OAAO,KAAK,UAAU;EAEjD,MAAM,gBAAgB,QAAQ,IAAI,CAAC,UACjC,KAAK,mBAAmB;GACtB,OAAO,KAAK;GACZ,OAAO;GAEP,WAAW;GAEX,gBAAgB,KAAK;EACtB,EAAC,CACH;EAED,MAAM,iBAAiB,MAAM,QAAQ,IAAI,cAAc;EAEvD,MAAMC,aAAyB,CAAE;AAEjC,OAAK,IAAI,IAAI,GAAG,IAAI,eAAe,QAAQ,KAAK,GAAG;GACjD,MAAM,QAAQ,QAAQ;GACtB,MAAM,EAAE,YAAY,eAAe,GAAG,eAAe;AACrD,QAAK,IAAI,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK,EACrC,KAAI,WAAW,iBAAiB,cAAc,OAC5C,WAAW,KAAK,cAAc,MAAM,GAAG;YAC9B,MAAM,QAAQ,cAAc,EACrC,WAAW,KAAK,cAAc,GAAa;EAGhD;AAED,SAAO;CACR;;;;;;CAOD,MAAM,WAAWC,MAAiC;EAChD,MAAM,EAAE,YAAY,GAAG,MAAM,KAAK,mBAAmB;GACnD,OAAO,KAAK;GACZ,OAAO,CAAC,IAAK;GAEb,WAAW;GAEX,gBAAgB,KAAK;EACtB,EAAC;AACF,MAAI,WAAW,cAAc,WAAW,MACtC,QAAO,WAAW,MAAM;WACf,MAAM,QAAQ,WAAW,CAClC,QAAO,WAAW;MAElB,OAAM,IAAI,MACR,CAAC,4CAA4C,EAAE,KAAK,UAClD,YACA,MACA,EACD,EAAE;CAGR;CAED,MAAM,MAAMC,SAA0C;EACpD,MAAM,EAAE,YAAY,GAAG,MAAM,KAAK,mBAAmB,QAAQ;AAC7D,MAAI,WAAW,cAAc,WAAW,MACtC,QAAO,WAAW,MAAM;WACf,MAAM,QAAQ,WAAW,CAClC,QAAO,WAAW;MAElB,OAAM,IAAI,MACR,CAAC,4CAA4C,EAAE,KAAK,UAClD,YACA,MACA,EACD,EAAE;CAGR;;;;;;CAOD,MAAc,mBACZC,SACA;AACA,SAAO,KAAK,OAAO,KAAK,YAAY;GAClC,IAAI;AACJ,OAAI;IACF,WAAW,MAAM,KAAK,OAAO,MAAM,QAAQ;GAE5C,SAAQC,GAAQ;IACf,EAAE,SAAS,EAAE,UAAU,EAAE;AACzB,UAAM;GACP;AACD,UAAO;EACR,EAAC;CACH;CAED,IAAI,aAAoD;AACtD,SAAO;GACL,QAAQ;GACR,SAAS;EACV;CACF;CAED,IAAI,aAAoD;AACtD,SAAO;GACL,QAAQ;GACR,SAAS;EACV;CACF;AACF"}